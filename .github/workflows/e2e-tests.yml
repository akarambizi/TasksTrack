name: E2E Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read

jobs:
  test:
    timeout-minutes: 45
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Playwright Browsers
      working-directory: ./client
      run: |
        npm ci
        npx playwright install --with-deps

    - name: Start application stack
      run: |
        echo "ðŸš€ Starting fresh application stack..."
        make fresh

    - name: Pre-test verification
      run: |
        echo "ðŸš¦ Final pre-test verification..."
        docker ps

        echo "Network connectivity test:"
        curl -f http://localhost:5206/health | head -c 100 || (echo "âŒ Server health check failed" && exit 1)
        curl -f http://localhost:3000/ | head -c 100 || (echo "âŒ Client connection failed" && exit 1)

        echo "âœ… All services verified - proceeding to E2E tests!"

    - name: Run E2E tests
      working-directory: ./client
      run: npx playwright test --project=chromium --project=firefox --project=webkit --reporter=list
      env:
        CI: true

    - name: Stop application stack
      if: always()
      run: |
        echo "ðŸ›‘ Stopping application stack..."
        make down

        echo "ðŸ“‹ Final container status:"
        docker ps -a || true

    - name: Collect logs on failure
      if: failure()
      run: |
        echo "ðŸ“‹ Collecting logs for debugging..."
        mkdir -p debug-logs
        docker-compose logs database > debug-logs/database.log 2>&1 || true
        docker-compose logs server > debug-logs/server.log 2>&1 || true
        docker-compose logs client > debug-logs/client.log 2>&1 || true

        echo "ðŸ“Š System status at failure:"
        docker ps -a > debug-logs/containers.log 2>&1 || true
        docker images > debug-logs/images.log 2>&1 || true

        echo "Debug logs collected in debug-logs/"
        ls -la debug-logs/

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: client/playwright-report/
        retention-days: 30

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: client/test-results/
        retention-days: 30

    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: debug-logs
        path: debug-logs/
        retention-days: 7
