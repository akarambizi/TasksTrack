# Entity Framework Core Migrations Troubleshooting Guide

## Table of Contents

- [Quick Diagnostics](#quick-diagnostics)
- [Common Issues & Solutions](#common-issues--solutions)
- [Emergency Procedures](#emergency-procedures)
- [Best Practices](#best-practices)
- [Useful Commands](#useful-commands)
- [External Resources](#external-resources)

---

## Quick Diagnostics

### Step 1: Identify the Issue Type

Run these commands to gather information:

```bash
# Check current migration status
dotnet ef migrations list

# View pending migrations
dotnet ef database update --dry-run

# Check database connection
dotnet ef database drop --dry-run
```

### Step 2: Review Migration Files

```bash
# Check recent migrations
ls -la Migrations/ | tail -5

# View specific migration content
cat Migrations/YourMigrationName.cs
```

### Step 3: Check Application Logs

Look for these error patterns:

- `Cannot be cast automatically to type`
- `Table 'X' already exists`
- `Column 'Y' does not exist`
- `Foreign key constraint fails`

---

## Common Issues & Solutions

### Issue 1: "Cannot cast column to type" Error

**Symptoms:**
```
42804: column "UpdatedDate" cannot be cast automatically to type timestamp with time zone
```

**Root Cause:** Model type doesn't match database column type

**Solution:**

1. Check model vs database mismatch:
   ```csharp
   // C# Model
   public DateTime CreatedDate { get; set; }  // Expects timestamp

   // Database (from old migration)
   "CreatedDate" text NOT NULL  // Actually text
   ```

2. Create manual migration:
   ```csharp
   // Option A: Add new column with different name
   migrationBuilder.AddColumn<DateTime>(
       name: "CreatedDateNew",
       table: "TableName",
       type: "timestamp with time zone");

   // Option B: Use USING clause for conversion
   migrationBuilder.Sql(@"
       ALTER TABLE ""TableName""
       ALTER COLUMN ""CreatedDate""
       TYPE timestamp with time zone
       USING ""CreatedDate""::timestamp with time zone");
   ```

**Prevention:** Keep model types consistent with database schema

### Issue 2: "Table already exists" Error

**Symptoms:**
```
Table 'Users' already exists
```

**Root Cause:** Migration trying to create existing table

**Solutions:**

**Option A: Skip problematic migration**
```bash
# Mark migration as applied without running it
dotnet ef database update YourMigrationName --connection "YourConnectionString"
```

**Option B: Create conditional migration**
```csharp
protected override void Up(MigrationBuilder migrationBuilder)
{
    migrationBuilder.Sql(@"
        DO $$
        BEGIN
            IF NOT EXISTS (SELECT 1 FROM information_schema.tables
                          WHERE table_name = 'Users') THEN
                CREATE TABLE ""Users"" (
                    ""Id"" integer GENERATED BY DEFAULT AS IDENTITY,
                    ""Email"" text NOT NULL
                );
            END IF;
        END $$;
    ");
}
```

### Issue 3: Migration Dependency Issues

**Symptoms:**
```
Migration 'X' depends on migration 'Y' which is not applied
```

**Solution:**
```bash
# Check migration history
dotnet ef migrations list

# Apply missing migrations in order
dotnet ef database update

# Force specific migration order
dotnet ef database update SpecificMigrationName
```

### Issue 4: Foreign Key Constraint Failures

**Symptoms:**
```
Cannot add foreign key constraint
```

**Solutions:**

**Option A: Drop and recreate constraints**
```csharp
protected override void Up(MigrationBuilder migrationBuilder)
{
    // Drop existing constraint
    migrationBuilder.DropForeignKey(
        name: "FK_Table_Referenced",
        table: "Table");

    // Add new constraint
    migrationBuilder.AddForeignKey(
        name: "FK_Table_Referenced_New",
        table: "Table",
        column: "ReferencedId",
        principalTable: "Referenced",
        principalColumn: "Id");
}
```

**Option B: Use raw SQL for complex scenarios**
```csharp
migrationBuilder.Sql(@"
    ALTER TABLE ""Table""
    ADD CONSTRAINT ""FK_Table_Referenced""
    FOREIGN KEY (""ReferencedId"")
    REFERENCES ""Referenced""(""Id"")
    ON DELETE CASCADE;
");
```

### Issue 5: Model Snapshot Out of Sync

**Symptoms:**
- Unexpected columns in migrations
- Missing tables in snapshot

**Solution:**
```bash
# Remove all migrations (CAUTION: Development only)
rm -rf Migrations/

# Recreate from current model
dotnet ef migrations add InitialCreate

# Or manually fix snapshot file
# Edit: Migrations/ContextModelSnapshot.cs
```

---

## Emergency Procedures

### Complete Reset (Development Only)

```bash
# 1. Stop application
docker-compose down

# 2. Backup data if needed
pg_dump dbname > backup.sql

# 3. Drop database
dotnet ef database drop --force

# 4. Remove migrations
rm -rf Migrations/

# 5. Create fresh migration
dotnet ef migrations add InitialCreate

# 6. Apply migration
dotnet ef database update
```

### Production Emergency: Rollback Migration

```bash
# 1. Identify last good migration
dotnet ef migrations list

# 2. Rollback to specific migration
dotnet ef database update LastGoodMigrationName

# 3. Remove problematic migration file
rm Migrations/ProblematicMigration.cs
```

### Partial Migration Failure Recovery

```bash
# 1. Check which statements succeeded
SELECT * FROM "__EFMigrationsHistory";

# 2. Manually finish migration or rollback
# Use SQL scripts to complete/undo changes

# 3. Mark migration as applied
INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('YourMigrationId', '8.0.0');
```

---

## Best Practices

### Development Workflow

1. Always review auto-generated migrations
2. Test migrations on development database first
3. Use descriptive migration names
4. One logical change per migration
5. Keep migrations small and focused

### Production Deployment

1. Backup database before migrations
2. Test migrations on staging environment
3. Plan rollback strategy
4. Use maintenance windows for large changes
5. Monitor application after deployment

### Code Organization

```csharp
// Good: Focused migration
public partial class AddRefreshTokenToUsers : Migration

// Bad: Everything in one migration
public partial class UpdateEverything : Migration
```

### Data Type Consistency

```csharp
// Consistent throughout application
public DateTime CreatedAt { get; set; }
public DateTime UpdatedAt { get; set; }

// Not mixed types
public string CreatedDate { get; set; }  // Don't mix with DateTime
```

---

## Useful Commands

### Migration Management

```bash
# Create new migration
dotnet ef migrations add MigrationName

# List all migrations
dotnet ef migrations list

# Remove last migration (if not applied)
dotnet ef migrations remove

# Generate SQL script
dotnet ef migrations script

# Apply specific migration
dotnet ef database update MigrationName
```

### Database Operations

```bash
# Update to latest migration
dotnet ef database update

# Drop database
dotnet ef database drop

# Dry run (show what would happen)
dotnet ef database update --dry-run

# Generate create script
dotnet ef dbcontext script
```

### Troubleshooting Commands

```bash
# Check connection
dotnet ef database drop --dry-run

# Validate model
dotnet ef dbcontext info

# List DbContext types
dotnet ef dbcontext list

# Check migration status
dotnet ef migrations list --verbose
```

---

## External Resources

### Official Documentation

- [EF Core Migrations Overview](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [Managing Migration Scenarios](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/managing)
- [Custom Migration Operations](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/operations)
- [Team Environments](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/teams)

### PostgreSQL Specific

- [PostgreSQL Data Types](https://www.postgresql.org/docs/current/datatype.html)
- [PostgreSQL ALTER TABLE](https://www.postgresql.org/docs/current/sql-altertable.html)
- [Npgsql EF Core Provider](https://www.npgsql.org/efcore/)

### Tools & Utilities

- [EF Core Power Tools](https://marketplace.visualstudio.com/items?itemName=ErikEJ.EFCorePowerTools)
- [pgAdmin](https://www.pgadmin.org/) - PostgreSQL administration
- [DBeaver](https://dbeaver.io/) - Universal database tool

### Best Practices & Patterns

- [EF Core Best Practices](https://learn.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext)
- [Migration Strategies](https://www.entityframeworktutorial.net/efcore/entity-framework-core-migration.aspx)
- [Production Deployment Guide](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/applying)

### Troubleshooting Resources

- [Common EF Core Issues](https://github.com/dotnet/efcore/issues)
- [Stack Overflow EF Core](https://stackoverflow.com/questions/tagged/entity-framework-core)
- [EF Core GitHub Discussions](https://github.com/dotnet/efcore/discussions)

### Learning Resources

- [EF Core Documentation](https://docs.microsoft.com/en-us/ef/core/)
- [Pluralsight EF Core Course](https://www.pluralsight.com/courses/entity-framework-core-getting-started)
- [Microsoft Learn EF Core](https://learn.microsoft.com/en-us/training/modules/persist-data-ef-core/)

---

## Quick Reference Card

| Problem | Quick Fix | Command |
|---------|-----------|---------|
| Migration failed | Check logs | `docker logs container-name` |
| Table exists | Conditional creation | Use `IF NOT EXISTS` in SQL |
| Type mismatch | Manual migration | Create custom migration |
| Dependency issue | Apply in order | `dotnet ef database update` |
| Corrupted state | Nuclear reset | `dotnet ef database drop --force` |

---

**Last Updated:** October 19, 2025
**Version:** 1.0
**Maintained by:** TasksTrack Development Team

For specific issues not covered here, consult the [case studies](./case-studies/) folder or create a new issue documentation.